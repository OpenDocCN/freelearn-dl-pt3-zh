<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">DL on AWS Using Python: Object Detection and Home Automation</h1>
                </header>
            
            <article>
                
<p>We familiarized ourselves with a few deep-learning-based offerings from Google Cloud Platform and learned how they can be used in <a href="093890b6-051d-49f9-9330-bdd58b92a762.xhtml">Chapter 6</a>, <em>Deep Learning on Google Cloud Platform Using Python</em>. Now that we have a fairly good overview of cloud computing, in this chapter, we will introduce another cloud computing platform, <strong>Amazon Web Services</strong> (<strong>AWS</strong>), which also offers some high-performing and highly reliable deep-learning-based solutions to make life easier. In this chapter, we are going to introduce two of them in the form of APIs and learn how they can be consumed from a Python program.</p>
<p>We will start by setting up our AWS account and configuring boto3 in Python. We will then learn how to use the <span>Rekognition API and the Alexa API in Python.</span></p>
<p>In this chapter, we will cover the following topics:</p>
<ul>
<li style="font-weight: 400">Setting up your AWS account</li>
<li style="font-weight: 400">AWS offerings in brief</li>
<li style="font-weight: 400">Configuring boto3 in Python</li>
<li style="font-weight: 400">Using the Rekognition API in Python</li>
<li style="font-weight: 400">Using the Alexa API in Python</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Technical requirements</h1>
                </header>
            
            <article>
                
<p>You can access the code for this chapter at <a href="https://github.com/PacktPublishing/Hands-On-Python-Deep-Learning-for-Web/tree/master/Chapter7">https://github.com/PacktPublishing/Hands-On-Python-Deep-Learning-for-Web/tree/master/Chapter7</a>.</p>
<p>To run the code in this chapter, you'll need the following software:</p>
<ul>
<li>Python 3.6+</li>
<li>The Python PIL library</li>
</ul>
<p>All other installations will be described during the course of the chapter.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting started in AWS</h1>
                </header>
            
            <article>
                
<p>Before using any AWS services or APIs, you will have to create your AWS account. In this section, we will quickly go through the steps to create an account in AWS:</p>
<ol>
<li>The first step is to go to <a href="https://aws.amazon.com/">https://aws.amazon.com/</a>. You should land on a page that resembles the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1350 image-border" src="assets/6c5749db-c62e-4e24-b514-9ca21e1afe34.png" style="width:53.33em;height:19.67em;"/></p>
<ol start="2">
<li>Then click on the <span class="packt_screen">Create an AWS Account</span> button, which should take you to the following page:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1351 image-border" src="assets/69673107-63a9-4cbd-99da-9d9d8fc6876b.png" style="width:53.25em;height:33.17em;"/></p>
<ol start="3">
<li>Fill in the fields and click on <span class="packt_screen">Continue</span>.</li>
<li>The portal will ask for some more mandatory information from you. It will also ask you to register a payment method in order to verify your details.</li>
</ol>
<div class="packt_infobox">If you do not provide this, you will not be entitled to use the free tier of <span>AWS</span> <span>facilities.</span></div>
<ol start="5">
<li>Towards the very last step of your registration, you will be asked to choose between three plans—<span class="packt_screen">Free</span>, <span class="packt_screen">Developer</span>, and <span class="packt_screen">Business</span>. Choose whichever is relevant to your needs and proceed.</li>
</ol>
<p style="padding-left: 60px">Like Google Cloud Platform, AWS also offers free tier access. When you sign up for AWS for the first time, you get to use a wide range of AWS services and products for free, but only up to a certain quota. You can go to <a href="https://aws.amazon.com/free/">https://aws.amazon.com/free/</a> to learn more about this.</p>
<p style="padding-left: 60px">You should get a page like the following once you follow the preceding steps:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1352 image-border" src="assets/5ff22c05-d2b5-4d25-9f60-b37da3ec231c.png" style="width:55.83em;height:25.08em;"/></p>
<p style="padding-left: 60px">AWS has this beautiful feature of recommending solutions and services for its users. In order to make the most of this feature, you need to enter two things—your role and your subject of interest. You can see this in the preceding screenshot. Enter these two details and hit <span class="packt_screen">Submit</span> for some targeted product recommendations.</p>
<ol start="6">
<li>The next step is to click on the <span class="packt_screen">Sign In to the Console</span> button.</li>
</ol>
<p style="padding-left: 60px">When you are successfully logged in to your AWS console, you should see the following window:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1353 image-border" src="assets/fe00e39b-59ba-4a1f-a61c-0f67d4cca381.png" style="width:57.17em;height:36.58em;"/></p>
<p>The AWS console is the place where you can find all the services and solutions that AWS has to offer. Feel free to explore the complete set of services by clicking on the <span class="packt_screen">Services</span> tab. You can also search for a particular service from the search bar.</p>
<p>By now, <span>our AWS accounts</span> <span>should be ready enough for us to get our hands dirty. In the next section, we'll review the offerings of AWS briefly to get a better sense of the platform.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">A short tour of the AWS offerings</h1>
                </header>
            
            <article>
                
<p>AWS offers its services and solutions in a variety of domains. The following are the different types of module that AWS offers (the ones in brackets are the names of the different services offered by AWS):</p>
<ul>
<li style="font-weight: 400">Compute (EC2, Lambda, and so on)</li>
<li style="font-weight: 400">Storage (S3, Storage Gateway, and so on)</li>
<li style="font-weight: 400">Machine learning (Amazon SageMaker, AWS DeepLens, and so on)</li>
<li style="font-weight: 400">Database (RDS, DynamoDB, and so on)</li>
</ul>
<ul>
<li style="font-weight: 400">Migration and transfer (Snowball, DataSync, and so on)</li>
<li style="font-weight: 400">Networking and content delivery (CloudFront, VPC, and so on)</li>
<li style="font-weight: 400">Developer tools (CodeStar, CodeCommit, and so on)</li>
<li style="font-weight: 400">Robotics (AWS RoboMaker)</li>
<li style="font-weight: 400">Blockchain (Amazon Managed Blockchain)</li>
<li style="font-weight: 400">Analytics (Athena, CloudSearch, and so on)</li>
</ul>
<p>There are also many others, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1354 image-border" src="assets/e773d1e1-5b71-45f0-b465-66fc5d2902dd.png" style="width:57.83em;height:32.00em;"/></p>
<p class="CDPAlignLeft CDPAlign">The list is actually pretty extensive, but let's restrict our focus to machine learning (also known as deep learning) services for the time being.</p>
<p class="CDPAlignLeft CDPAlign">The search bar in the AWS console also lets you search for the AWS APIs that you may already have heard of. Let's type <kbd>Rekognition</kbd> in there and hit <em>Enter</em>. You should be provided with the home page of Rekognition, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1355 image-border" src="assets/4df1029c-865e-4d73-8f88-fcb487bf9849.png" style="width:54.42em;height:25.83em;"/></p>
<p>We will explore the Rekognition API in more detail later in the chapter. In the next section, we will learn how to use boto3 (an AWS SDK that provides a programming interface in Python) to interact with different AWS resources.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting started with boto3</h1>
                </header>
            
            <article>
                
<p>boto3 is the official library for communicating with AWS APIs, provided by the AWS team. You can find the library at <a href="https://aws.amazon.com/sdk-for-python/">https://aws.amazon.com/sdk-for-python/</a>, and it can be installed using the following command:</p>
<pre><strong>pip install boto3</strong></pre>
<p>After installation, you need to configure boto3 for use with your project. To configure boto3 (<a href="https://bit.ly/2OvXAvb">https://bit.ly/2OvXAvb</a><span>), the first step is to get your AWS</span> access <span>keys from the</span> <strong>Identity and Access Management</strong> <span>(</span><strong>IAM</strong><span>) console. Go through the following steps to perform the configuration:</span></p>
<ol>
<li>Go to your AWS IAM console at <a href="https://console.aws.amazon.com/iam">https://console.aws.amazon.com/iam</a>. It will look like the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1356 image-border" src="assets/53fc5106-5219-4269-9ace-5c45edc32c8b.png" style="width:60.33em;height:26.42em;"/></p>
<p style="padding-left: 60px">On the preceding dashboard, you will be able to see the access keys.</p>
<ol start="2">
<li>Cli<span>ck</span> <span>on</span> <strong><span class="packt_screen">Delete your root access keys</span></strong> <span>and then</span> <strong><span class="packt_screen">Manage Security Credentials</span></strong><span>. You will be presented with the following window:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1357 image-border" src="assets/3bb72eab-b62e-42b6-9dee-6cd77653770d.png" style="width:60.42em;height:20.42em;"/></p>
<ol start="3">
<li>Expand the <strong><span class="packt_screen">Access keys (access key ID and secret access key)</span></strong> <span>tab and get the access keys from there. You should get the following message once the keys are generated successfully:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1358 image-border" src="assets/2426808b-f6a7-462d-9692-8162fc50efbd.png" style="width:41.17em;height:10.83em;"/></p>
<ol start="4">
<li>Download the key file and keep it in a secure place, as you will need this in order to configure boto3.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring environment variables and installing boto3</h1>
                </header>
            
            <article>
                
<p>Once you have the access keys, create two environmental variables, <kbd>aws_access_key_id</kbd> and <kbd>aws_secret_access_key</kbd>. Now, assign their values accordingly with the help of the keys you have. The keys will have information that will help you distinguish between the key ID and the secret access key. Now that you have configured the necessary environment variables, we can start off by loading the environment variables in Python.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Loading up the environment variables in Python</h1>
                </header>
            
            <article>
                
<p>Once the library is successfully installed, you can load up the environment variables you just created with the following lines of code:</p>
<pre>import os<br/>aws_access_key_id= os.environ['aws_access_key_id']<br/>aws_secret_access_key = os.environ['aws_secret_access_key']</pre>
<p>Once the environment variables are loaded up properly, we can call boto3 to interact with an AWS resource. Let's say you want to enlist the S3 buckets that you have in your AWS account and want to upload an image to a particular bucket. S3 is the AWS resource that you want to access. If you do not have any S3 buckets in your AWS account, no worries; you can quickly create one.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating an S3 bucket</h1>
                </header>
            
            <article>
                
<p><span>You can quickly create an S3 bucket by going through the following steps:</span></p>
<ol>
<li>Go to the home page of the S3 console at <a href="https://s3.console.aws.amazon.com/s3">https://s3.console.aws.amazon.com/s3</a>. It should look like the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1359 image-border" src="assets/2f02b3a1-2449-470f-a1ab-2ee93093e353.png" style="width:40.83em;height:18.00em;"/></p>
<ol start="2">
<li>Click on <strong><span class="packt_screen">Create bucket</span></strong>. You will be asked to enter the following details:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1360 image-border" src="assets/e9399ac7-840c-447c-93be-18677c3b69ea.png" style="width:39.83em;height:21.75em;"/></p>
<ol start="3">
<li>Give a name for your bucket, leave everything as it is, and click on <strong><span class="packt_screen">Create</span></strong>. Once the bucket is successfully created, you will be able to see it from the S3 console:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1361 image-border" src="assets/86871ff5-e121-4939-b639-80c9587e7c56.png" style="width:40.58em;height:8.75em;"/></p>
<p>Next, we will learn how to access S3 from Python code with boto3.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Accessing S3 from Python code with boto3</h1>
                </header>
            
            <article>
                
<p>Now, you can access your S3 bucket from Python code. The following lines of code will show you the available buckets:</p>
<pre>import boto3<br/>s3 = boto3.resource(<br/>    's3',<br/>    aws_access_key_id=aws_access_key_id,<br/>    aws_secret_access_key=aws_secret_access_key<br/>)</pre>
<p><span>You specified</span> <span>that</span> you are interested in accessing S3 in the first argument of the <kbd>resource()</kbd>. You can read the documentation at <a href="https://bit.ly/2VHsvnP">https://bit.ly/2VHsvnP</a>. You can now find the available buckets with the following lines of code:</p>
<pre>for bucket in s3.buckets.all():<br/> print(bucket.name)</pre>
<p>You should get the list as the output. Now, say you want to upload an image to one of the buckets. Provided that the image you want to upload is in your current working directory, the following lines of code should upload an image to a particular S3 bucket:</p>
<pre>data = open('my_image.jpeg', 'rb')<br/>s3.Bucket('demo-bucket-sayak').put_object(Key='my_image.jpeg', Body=data)</pre>
<p class="mce-root"/>
<p>The preceding lines of code contain the following features:</p>
<ul>
<li style="font-weight: 400"><kbd>my_image.jpeg</kbd> is the path of the image you want to upload.</li>
<li style="font-weight: 400">Within the <kbd>Bucket()</kbd> method is the name of the S3 bucket that the image will be uploaded to.</li>
</ul>
<p>If the code is successfully executed, you should receive the following output:</p>
<pre>s3.Object(bucket_name='demo-bucket-sayak', key='my_image.jpeg')</pre>
<p>You can verify whether the image was uploaded by going to your AWS S3 console and then entering the bucket that you uploaded the image to. You should see something like the following in there:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1362 image-border" src="assets/ea5a0e67-5997-4205-836e-532a4560ee54.png" style="width:85.58em;height:12.17em;"/></p>
<p>Now that you have configured boto3 successfully in Python, we can now move on to learn how to use the Rekognition and Alexa API in Python using boto3.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using the Rekognition API in Python</h1>
                </header>
            
            <article>
                
<p>Amazon Rekognition is a deep-learning-enabled visual-analysis service that can help you search, verify, and analyze billions of images seamlessly. Let's first review the Recognition API briefly and then we will jump straight into using it in Python. Let's first go to the home page of the Rekognition API at <a href="https://console.aws.amazon.com/rekognition/home">https://console.aws.amazon.com/rekognition/home</a>. We have already seen Rekognition<span>'s home page</span> in one of the earlier sections of this chapter.</p>
<p>As you might have already noticed from the navigation bar, the Rekognition API has several things to offer:</p>
<ul>
<li style="font-weight: 400"><strong>Object and scene detection</strong>: This lets you automatically label objects, labels, and scenes from a given image (along with confidence scores).</li>
<li style="font-weight: 400"><strong>Image moderation</strong>: This allows you to detect explicit or suggestive adult content in images, along with confidence scores.</li>
</ul>
<ul>
<li style="font-weight: 400"><strong>Celebrity recognition</strong>: Using this, you can automatically recognize celebrities in images (along with confidence scores).</li>
<li style="font-weight: 400"><strong>Face comparison</strong>: This can be used to see how closely faces match based on a similarity percentage.</li>
</ul>
<p>In addition to these features, it has many more.</p>
<p>The solutions offered by the Rekognition API have proven to be extremely useful for a wide variety of organizations because they genuinely solve some real-world and challenging problems. You can try a quick demo of any of the solutions mentioned in the preceding list by clicking on their respective solutions on the API home page. Let's try the celebrity recognition solution.</p>
<p>First, go to <a href="https://console.aws.amazon.com/rekognition/home?region=us-east-1#/celebrity-detection">https://console.aws.amazon.com/rekognition/home?region=us-east-1#/celebrity-detection</a> (note that the region may vary). It should look like the following image:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1363 image-border" src="assets/5d0a60f8-7ee3-4e21-84ec-0679a3475f7f.png" style="width:52.50em;height:25.08em;"/></p>
<p>The portal will let you upload your own image and test it. Let's test my image <span>(we could have taken images of media celebrities, but those images are copyright protected).</span> You can see the result as expected:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1364 image-border" src="assets/48570a56-c2cb-48b9-8d36-309bf77bcf96.png" style="width:40.25em;height:20.92em;"/></p>
<p>Feel free to try the other solutions as well. Let's now see how the Rekognition API can be used from Python code:</p>
<ol>
<li class="CDPAlignLeft CDPAlign">Create a new Jupyter Notebook. First off, you will want to create a new Jupyter notebook with the name of, say, <kbd>Sample.ipynb</kbd>. You will have to provide an image that you want to test for celebrity recognition using the AWS Rekognition API, as shown in the following directory structure screenshot of Jupyter:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1365 image-border" src="assets/036c3c11-7381-44b9-83a5-f2c6f4f0b71f.png" style="width:16.42em;height:15.42em;"/></p>
<ol start="2">
<li class="mce-root">Impor<span>t the environment variables for the credentials in your AWS account. You will need to import your account credentials into your script as you previously did in the boto3 configuration section. To do this, use the following code:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">import os<br/>aws_access_key_id= os.environ['aws_access_key_id']<br/>aws_secret_access_key = os.environ['aws_secret_access_key']</pre>
<ol start="3">
<li class="mce-root">Create <span>an AWS Rekognition API client using boto3. We are now ready to instantiate a boto3 Rekognition API client object. To do this, we need to pass the API that we wish to use to the <kbd>boto3</kbd> object, along with the AWS region name in which you wish to use the API. You will also have to pass in the credentials that you retrieved in the previous step, as shown in the following code:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">import boto3<br/>client=boto3.client('rekognition', region_name='us-east-1', aws_access_key_id=aws_access_key_id, aws_secret_access_key=aws_secret_access_key) </pre>
<ol start="4">
<li>Read the image from the disk and pass it to the API. There are two methods of posting files to AWS APIs from the boto3 SDK. Firstly, you could send them directly from an S3 bucket that you have permissions for, or you could send the image as a <kbd>Bytes</kbd> array from your local disk. We have already seen how you can find images from S3 buckets in the previous section.</li>
</ol>
<p>We shall now show you an example where we take a number of images from the local disk and pass them in an API call:</p>
<ol>
<li>First, read the image into a variable using Python's native method to open a file, as shown in the following code:</li>
</ol>
<pre style="padding-left: 60px">image = open("image.jpg", "rb")</pre>
<ol start="2">
<li>Now, to pass it to the API through the client we instantiated earlier, use the following line of code:</li>
</ol>
<pre style="padding-left: 60px">response = client.recognize_celebrities(Image={'Bytes':image.read()})</pre>
<ol start="3">
<li>Observe the response. Once the API call has succeeded, your <kbd>response</kbd> variable will hold the information returned by the API. To see it, print the variable:</li>
</ol>
<pre style="padding-left: 60px">{'CelebrityFaces': [{'Urls': ['www.imdb.com/name/nm1682433'],<br/> 'Name': 'Barack Obama',<br/> 'Id': '3R3sg9u',<br/> 'Face': {'BoundingBox': {'Width': 0.3392857015132904,<br/> 'Height': 0.27056020498275757,<br/> 'Left': 0.324404776096344,<br/> 'Top': 0.06436233967542648},<br/> 'Confidence': 99.97088623046875,<br/> 'Landmarks': [{'Type': 'eyeLeft',<br/> 'X': 0.44199424982070923,<br/> 'Y': 0.17130307853221893},<br/> {'Type': 'eyeRight', 'X': 0.5501364469528198, 'Y': 0.1697501391172409},<br/> {'Type': 'nose', 'X': 0.4932120144367218, 'Y': 0.2165488302707672},<br/> {'Type': 'mouthLeft', 'X': 0.43547138571739197, 'Y': 0.25405779480934143},<br/> {'Type': 'mouthRight', 'X': 0.552975058555603, 'Y': 0.2527817189693451}],<br/> 'Pose': {'Roll': -1.301725149154663,<br/> 'Yaw': -1.5216708183288574,<br/> 'Pitch': 1.9823487997055054},<br/> 'Quality': {'Brightness': 82.28946685791016,<br/> 'Sharpness': 96.63640594482422}},<br/> 'MatchConfidence': 96.0}],<br/> 'UnrecognizedFaces': [],<br/> 'ResponseMetadata': {'RequestId': 'ba909ea2-67f1-11e9-8ac8-39b792b4a620',<br/> 'HTTPStatusCode': 200,<br/> 'HTTPHeaders': {'content-type': 'application/x-amz-json-1.1',<br/> 'date': 'Fri, 26 Apr 2019 07:05:55 GMT',<br/> 'x-amzn-requestid': 'ba909ea2-67f1-11e9-8ac8-39b792b4a620',<br/> 'content-length': '813',<br/> 'connection': 'keep-alive'},<br/> 'RetryAttempts': 0}}</pre>
<p style="padding-left: 60px">The API recognizes our image as that of Barack Obama. It gives us a lot of other useful information, such as the <kbd>BoundingBox</kbd> where the face was matched, the <kbd>Confidence</kbd> of the prediction, the location of the eyes, mouth, and nose, and so on. We can use this information to further operate on the image—say, to simply crop out the matched part.</p>
<ol start="4">
<li>Get the matched part of the image. To prepare a cropped version of the image in the places where it was recognized, we can use the following code:</li>
</ol>
<pre style="padding-left: 60px">from PIL import Image<br/>from IPython.display import display<br/><br/>im=Image.open('image.jpg')<br/>w, h = im.size<br/><br/>celeb = response['CelebrityFaces'][0]['Face']['BoundingBox']<br/><br/>x1 = (celeb["Left"])*w<br/>y1 = (celeb["Top"])*h<br/>x2 = (celeb["Left"] + celeb["Width"])*w<br/>y2 = (celeb["Top"] + celeb["Height"])*h<br/><br/>box=(x1,y1,x2,y2)<br/>im1=im.crop(box)<br/><br/>display(im1)</pre>
<p>You should see the following image as the final result, which is the bounding box generated by the API for performing celebrity recognition:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1366 image-border" src="assets/175087bb-bb71-47a3-80ae-81095e96551f.png" style="width:19.50em;height:26.50em;"/></p>
<p>On further exploration of the boto3 API for AWS, you'll realize that it is capable of handling all AWS services, and is not just limited to the Rekognition API. This means that, based on the API specification requirements, the preceding sample code can be used for nearly all the available APIs, with small modifications.</p>
<p>In the upcoming section, we'll take a look at Alexa, a flagship offering by Amazon for building voice interfaces that can span in their capabilities from being a chatbot to a virtual personal assistant. We'll learn how we can build a simple home automation solution using Alexa.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using the Alexa API in Python</h1>
                </header>
            
            <article>
                
<p>Amazon Alexa is a voice-based personal assistant developed by Amazon. The product first featured as an interface for Amazon Echo devices, which went on to inspire the Google Home devices by Google, which use Google Assistant. Other competitors of Alexa are Microsoft's Cortana and Apple's Siri. As a virtual assistant, Alexa can easily set up calls, schedule meetings, or play songs. The various tasks that Alexa can perform are called <em>skills</em> in the Alexa terminology, which we'll be following in this section.</p>
<p>Skills in Alexa are the main core of how we can bring functionality to the platform. Each skill needs to be invoked from the primary interface of Alexa, whereupon the skill takes over the entire functionality unless the program logic completes or the user explicitly asks for the skill to end. Skills apply the logic for the task to be performed, and so this logic needs to be stored somewhere, perhaps also along with a database and execution runtime. While a lot of skills are hosted over several services, such as Heroku, PythonAnywhere, GCP, and others, it is very common to host skills, logic code as AWS Lambda functions.</p>
<p>In this section, we shall be creating a sample Home Automation Alexa skill using the Python SDK for Alexa and will host it on AWS Lambda.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Prerequisites and a block diagram of the project</h1>
                </header>
            
            <article>
                
<p>Before you can jump into building an Alexa skill, you will need the following two types of accounts on AWS and Amazon Developer respectively:</p>
<ul>
<li>An AWS account (the free tier works)—<a href="https://aws.amazon.com/">aws.amazon.com</a></li>
<li>An Amazon Developer account (this is free)—<a href="https://developer.amazon.com/">developer.amazon.com</a></li>
</ul>
<p>Once you have <span>created</span> <span>these accounts—the process of which is beyond the scope of this book—you can proceed to create our skill for home automation. The architecture of the</span> Home Automation skill <span>we shall be creating is shown in the following block diagram:</span></p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1437 image-border" src="assets/dc3b9bf7-c327-4b8b-ab37-7039b36c77f6.png" style="width:40.33em;height:21.17em;"/></p>
<p>In building this skill, we shall be using the following services, which you can read more about by going to the links in the following list:</p>
<ul>
<li><strong>Amazon Alexa Skills Kit:</strong> <a href="https://developer.amazon.com/alexa-skills-kit">https://developer.amazon.com/alexa-skills-kit</a></li>
<li><strong>Login with Amazon:</strong> <a href="https://developer.amazon.com/docs/login-with-amazon/minitoc-lwa-overview.html">https://developer.amazon.com/docs/login-with-amazon/minitoc-lwa-overview.html</a></li>
<li><strong>AWS CloudWatch:</strong> <a href="https://aws.amazon.com/cloudwatch/">https://aws.amazon.com/cloudwatch/</a></li>
<li><strong>Amazon DynamoDB:</strong> <a href="https://aws.amazon.com/dynamodb/">https://aws.amazon.com/dynamodb/</a></li>
<li><strong>AWS Lambda:</strong> <a href="https://aws.amazon.com/lambda/">https://aws.amazon.com/lambda/</a></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating a configuration for the skill</h1>
                </header>
            
            <article>
                
<p><span>Skills require a certain amount of connection between the services in order to work. In addition, the skill logic deployed on AWS Lambda needs to be configured to be used by the skill on Alexa. Create a <kbd>setup.txt</kbd> file in the root of your working folder with the following content. We shall be gradually adding to this content as we progress through the steps in this section:</span></p>
<pre>[LWA Client ID]<br/>amzn1.application-oa2-client.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<br/><br/>[LWA Client Secret]<br/>XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX<br/>    <br/>[Alexa Skill ID]<br/>amzn1.ask.skill.XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX<br/><br/>[AWS Lambda ARN]<br/>arn:aws:lambda:us-east-1:XXXXXXXXXXXX:function:skill-sample-language-smarthome-switch<br/><br/>[APIs]<br/>https://pitangui.amazon.com/api/skill/link/XXXXXXXXXXXXXX<br/>https://layla.amazon.com/api/skill/link/XXXXXXXXXXXXXX<br/>https://alexa.amazon.co.jp/api/skill/link/XXXXXXXXXXXXXX</pre>
<p>Throughout the following sections, we will be referring to this file as <kbd>setup.txt</kbd>. This essentially only holds information about your skill. Feel free to implement this in any other text editor as well, such as Google Docs.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up Login with Amazon</h1>
                </header>
            
            <article>
                
<p>For the Home Automation skill, you will need the Login with Amazon service enabled. To do this, go through the following steps:</p>
<ol>
<li>Go to <a href="https://developer.amazon.com/lwa/sp/overview.html">https://developer.amazon.com/lwa/sp/overview.html</a>. You will see the page shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1367 image-border" src="assets/4afa1398-744c-4718-bb55-0a9209e8ed04.png" style="width:37.75em;height:27.42em;"/></p>
<ol start="2">
<li>Click the <span class="packt_screen">Create a New Security Profile</span> button on the page that then loads.</li>
<li>Set <span class="packt_screen">Security Profile Name</span> as <kbd>Smart Home Automation Profile</kbd>.</li>
<li>Provide a description of the profile.</li>
<li>For <span class="packt_screen">Content Privacy Notice URL</span>, you will need a valid privacy policy web page to push the skill to production. Create and host a privacy policy and provide the link to it in this field. A very handy tool for creating privacy policies can be found at <a href="https://app-privacy-policy-generator.firebaseapp.com/">https://app-privacy-policy-generator.firebaseapp.com/</a>.</li>
<li>Click on <span class="packt_screen">Save</span>.</li>
<li>Click on the <span class="packt_screen">Security Profile</span> option in the gear menu that appears on the next page. You will be taken to the <span class="packt_screen">Security Profile Management</span> page, as shown in the following image:</li>
</ol>
<p style="padding-left: 90px" class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1368 image-border" src="assets/6baa4f01-2672-49cb-9e03-6dd1f0902cac.png" style="width:47.33em;height:30.25em;"/></p>
<ol start="8">
<li>From the list of security profiles, click the <span class="packt_screen">Web Settings</span> tab to the <span class="packt_screen">Show Client ID and Client Secret</span> link for the <span class="packt_screen">Home Automation Profile</span>.</li>
<li>Copy the displayed Client ID and Client Secret values and save them to the <kbd>setup.txt</kbd> file in the working directory, replacing the format example entries for <kbd>[LWA Client ID]</kbd> and <kbd>[LWA Client Secret]</kbd> respectively.</li>
</ol>
<p>Keep this tab open for future steps. Go through the steps in the next section in a new browser tab.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the skill</h1>
                </header>
            
            <article>
                
<p>We can now proceed with creating the skill:</p>
<ol>
<li>Log on to <a href="https://developer.amazon.com/alexa/console/ask">https://developer.amazon.com/alexa/console/ask</a> to begin the process. You will be able to see a screen resembling the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1369 image-border" src="assets/e055cf24-cc4d-4caf-87a6-b5187a26a92a.png" style="width:18.17em;height:12.33em;"/></p>
<ol start="2">
<li>Click on <span class="packt_screen">Create Skill</span>.</li>
<li>Set the name to <kbd>Home Automation Skill</kbd>, or a name of your choosing.</li>
<li>Under the <span class="packt_screen">C<span class="packt_screen">h</span></span><span class="packt_screen">oose a model to add to your skill</span> section, click on the <span class="packt_screen">Smart Home</span> model. Your selections should now resemble the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1370 image-border" src="assets/15bd4a33-02ec-4ab9-b0fc-7cd83f015eec.png" style="width:43.00em;height:24.08em;"/></p>
<ol start="5">
<li>Click on <span class="packt_screen">Create Skill</span> to complete the initial phase of the skill creation.</li>
<li>On the next page that appears, you'll be able to see the Skill ID. Copy this Skill ID to the <kbd>setup.txt</kbd> file in the local working directory.</li>
</ol>
<p>Do not close this tab, as you still have fields to fill in here. O<span>pen up a new browser tab to work in in</span> <span>the next section.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring the AWS Lambda function</h1>
                </header>
            
            <article>
                
<p>Before we can add the ARN for the Lambda function to the skill endpoints configuration, we must create a configuration for the Lambda function. You can do this by going through the following steps:</p>
<ol>
<li>Go to <a href="https://console.aws.amazon.com/iam/home#/policies">https://console.aws.amazon.com/iam/home#/policies</a>. You will be presented with a screen like the one shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1371 image-border" src="assets/0fdc474a-3051-4bab-9698-8a9d883cb2f6.png" style="width:54.83em;height:25.08em;"/></p>
<ol start="2">
<li>Click on <span class="packt_screen">Create policy</span>.</li>
<li>Enter the following JSON in the <span class="packt_screen">JSON</span> tab of the <span class="packt_screen">Create policy</span> editor:</li>
</ol>
<pre style="padding-left: 60px">{<br/> "Version": "2012-10-17",<br/> "Statement": [<br/> {<br/> "Effect": "Allow",<br/> "Action": [<br/> "logs:CreateLogStream",<br/> "dynamodb:UpdateItem",<br/> "logs:CreateLogGroup",<br/> "logs:PutLogEvents"<br/> ],<br/> "Resource": "*"<br/> }<br/> ]<br/> }</pre>
<ol start="4">
<li>Click on <span class="packt_screen">Review policy</span> and set the name of the policy to <kbd>HomeAutomationPolicy</kbd>.</li>
<li>Click on <span class="packt_screen">Create policy</span>.</li>
<li>Next, on the left-hand navigation menu of the page, click on <span class="packt_screen">Roles</span>.</li>
<li>Click on <span class="packt_screen">Create role</span>.</li>
<li>Select <span class="packt_screen">AWS service</span> and <span class="packt_screen">Lambda</span>, and click on <span class="packt_screen">Next: Permissions</span>.</li>
<li>Search for <span class="packt_screen">HomeAutomationPolicy</span> in the filtering field. Check the policy. Your screen should resemble the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1372 image-border" src="assets/38f026ca-5a81-427f-ad3c-dc5efa7357de.png" style="width:40.42em;height:21.50em;"/></p>
<ol start="10">
<li>Click on <span class="packt_screen">Next: Tags</span>.</li>
<li>Click on <span class="packt_screen">Next: Review</span>.</li>
<li>Set the <span class="packt_screen">Role</span> name to <kbd>lambda_home_automation</kbd>.</li>
<li>Click on <span class="packt_screen">Create role</span>.</li>
</ol>
<p>Let's now create the Lambda function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating the Lambda function</h1>
                </header>
            
            <article>
                
<p>With the suitable configuration for the Lambda function in place, we can now create the Lambda function itself. To do so, <span>in the AWS console,</span> <span>navigate to</span> <a href="https://console.aws.amazon.com/lambda/home?region=us-east-1">https://console.aws.amazon.com/lambda/home</a> <span>and go through the following steps:</span></p>
<ol>
<li>Click on <span class="packt_screen">Create function</span>.</li>
<li>Set the function name to <kbd>homeAutomation</kbd>.</li>
<li>Select the <kbd>Python 3.6</kbd> runtime.</li>
<li>Choose the <kbd>lambda_home_automation</kbd> role from the dropdown in the existing roles in the execution roles.</li>
<li>Click on <kbd>Create function</kbd>.</li>
<li class="CDPAlignLeft CDPAlign">Copy the Lambda ARN from the next page that appears, which has a message of congratulations for creating the Lambda function. Put this ARN in the <kbd>setup.txt</kbd> of our local working directory in the <span class="packt_screen">[AWS Lambda ARN]</span> field.<br/>
At this point, the screen should resemble the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1373 image-border" src="assets/c27dff75-763d-479c-aea9-4846c6cd2e08.png" style="width:41.08em;height:20.33em;"/></p>
<div class="CDPAlignLeft CDPAlign packt_infobox">Note that the triggers and destinations displayed on your screen might differ from the preceding screenshot.</div>
<ol start="7">
<li>On the left-hand navigation, click on <span class="packt_screen">Add trigger</span> to bring up the drop-down list of available triggers for your Lambda function, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1374 image-border" src="assets/4c5d75a8-1315-43f1-87d7-961a97ea98c4.png" style="width:31.83em;height:31.42em;"/></p>
<ol start="8">
<li>Click on <span class="packt_screen">Alexa Skills Kit</span> to bring up the configuration dialogue for this trigger.</li>
<li>Paste the Alexa Skill ID in the field for <span class="packt_screen">Skill ID</span>. We have stored this value in the <kbd>setup.txt</kbd> previously, and it will look like <kbd>amzn1.ask.skill.xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</kbd>.</li>
<li>Click on <span class="packt_screen">Add</span> to add the trigger and return to the Lambda function management screen.</li>
<li>Click on <span class="packt_screen">Save</span> at the top right of the page.</li>
</ol>
<p>After the final step, the trigger section will display details of the connected Alexa skill. If it does not, you should check that you have correctly followed the preceding steps.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring the Alexa skill</h1>
                </header>
            
            <article>
                
<p>Now, we need to configure the skill that we left open in another tab of the browser. We will do this by going through the following steps:</p>
<ol>
<li>Return to that tab and fill in the ARN of the Lambda function in the <span class="packt_screen">Default endpoint</span> field.</li>
<li>Click on <span class="packt_screen">SAVE</span>.</li>
<li>Click on <span class="packt_screen">Setup Account Linking</span> at the bottom of the page.</li>
<li>For the <span class="packt_screen">Authorization URL</span>, enter <kbd>https://www.amazon.com/ap/oa</kbd>.</li>
<li>For the <span class="packt_screen">Access Token URL</span>, enter <kbd>https://api.amazon.com/auth/o2/token</kbd>.</li>
<li>For the <span class="packt_screen">Client ID</span> field, copy <kbd>[LWA Client ID]</kbd> from the <kbd>setup.txt</kbd> file.</li>
<li>For the <span class="packt_screen">Client Secret</span> field, copy <kbd>[LWA Client Secret]</kbd> from the <kbd>setup.txt</kbd> file.</li>
<li>Click on <span class="packt_screen">Add scope</span> and enter <kbd>profile:user_id</kbd>.</li>
<li>Copy the <span class="packt_screen">Redirect URLs</span> from the bottom of the page and paste them in the <kbd>setup.txt</kbd> file under the <span class="packt_screen">[APIs]</span> section. The URLs resemble the following:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1375 image-border" src="assets/81841ec1-c702-47ac-84d3-11fc81c679bd.png" style="width:46.33em;height:9.00em;"/></p>
<ol start="10">
<li>Click on <span class="packt_screen">Save</span>.</li>
<li>In the <span class="packt_screen">Security Profile Management</span> browser tab, click on the <span class="packt_screen">Web Settings</span> tab.</li>
<li>Click on <span class="packt_screen">Edit</span>, and add the three redirect URLs to the <span class="packt_screen">Allowed Return URLs</span> field. You will have to click on <span class="packt_screen">Add another</span> to enter multiple URLs.</li>
<li>Click on <span class="packt_screen">Save</span>.</li>
</ol>
<p>Let's now set up Amazon DynamoDB for the skill.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up Amazon DynamoDB for the skill</h1>
                </header>
            
            <article>
                
<p>For the skill to be able to save data from users, it needs a database. We will be using the Amazon DynamoDB service for this. The steps to set up the service are as follows:</p>
<ol>
<li>Go to <a href="https://console.aws.amazon.com/dynamodb/home?region=us-east-1">https://console.aws.amazon.com/dynamodb/home?region=us-east-1</a>.</li>
<li>Click on the <span class="packt_screen">Create table</span> button.</li>
<li>Enter the <span class="packt_screen">Table name</span> as <kbd>SmartHome</kbd>.</li>
<li>For the <span class="packt_screen">Primary key</span>, enter <kbd>ItemId</kbd>.</li>
<li>Leave all defaults as they are and click on <span class="packt_screen">Create</span>. Your screen should resemble the following screenshot in this step:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1376 image-border" src="assets/c1615057-9eee-451a-aa6e-49226c642255.png" style="width:53.33em;height:24.92em;"/></p>
<p>You can then go to the DynamoDB dashboard to see the table you just created; <span>however,</span> <span>this can take a few moments.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Deploying the code for the AWS Lambda function</h1>
                </header>
            
            <article>
                
<p>We're left with the final piece of the setup—the code that provides the logic to the AWS Lambda function. Go to your Lambda function configuration page and scroll down to the editor.</p>
<p>You will notice that the editor has a two-column interface: the left column displays the files in the Lambda function storage and in the right column, you can edit those files, as shown in the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1377 image-border" src="assets/83315a84-c753-4f37-980c-a9b5dd4e5ed8.png" style="width:54.67em;height:15.33em;"/></p>
<p class="CDPAlignLeft CDPAlign">Click on <kbd>lambda_function.py</kbd> to begin editing the file and go through the following steps:</p>
<ol>
<li class="mce-root"><span>Import the necessary modules. For the function to work, we will need the support of some common libraries, as shown in the following code:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">import boto3<br/>import json<br/>import random<br/>import uuid<br/>import time</pre>
<p style="padding-left: 60px" class="mce-root"><span>The boto3 API is used to connect to the Amazon DynamoDB instance we set up. The JSON module facilitates the generation of responses for the Alexa skill. The rest of the modules help to generate responses.</span></p>
<ol start="2">
<li class="mce-root">Create <span>the</span> <kbd>AlexaResponse</kbd> <span>class. In order to be able to fully replicate the Alexa skill's expected format of responses, we can quickly set up a helper class that can generate the responses for the Lambda function calls. Let's name it</span> <kbd>AlexaReponse</kbd><span>; the initialization of the class is shown in the following code snippet:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">class AlexaResponse:<br/><br/>    def __init__(self, **kwargs):<br/><br/>        self.context_properties = []<br/>        self.payload_endpoints = []<br/><br/>        # Set up the response structure<br/>        self.context = {}<br/>        self.event = {<br/>            'header': {<br/>                'namespace': kwargs.get('namespace', 'Alexa'),<br/>                'name': kwargs.get('name', 'Response'),<br/>                'messageId': str(uuid.uuid4()),<br/>                'payloadVersion': kwargs.get('payload_version', '3')<br/>            },<br/>            'endpoint': {<br/>                "scope": {<br/>                    "type": "BearerToken",<br/>                    "token": kwargs.get('token', 'INVALID')<br/>                },<br/>                "endpointId": kwargs.get('endpoint_id', 'INVALID')<br/>            },<br/>            'payload': kwargs.get('payload', {})<br/>        }<br/><br/>        if 'correlation_token' in kwargs:<br/>            self.event['header']['correlation_token'] = kwargs.get('correlation_token', 'INVALID')<br/><br/>        if 'cookie' in kwargs:<br/>            self.event['endpoint']['cookie'] = kwargs.get('cookie', '{}')<br/><br/>        if self.event['header']['name'] == 'AcceptGrant.Response' or self.event['header']['name'] == 'Discover.Response':<br/>            self.event.pop('endpoint')</pre>
<p style="padding-left: 60px" class="mce-root"><span>The preceding initialization method for the <kbd>AlexaResponse</kbd> class sets the expected output format and the various constant settings, such as the version number for the payload, and some basic validation for the output object. Next, we create the method for adding content properties and another method for setting cookies in the responses. Finally, another method is added to set up the payload endpoints:</span></p>
<pre style="color: black;padding-left: 60px">def add_context_property(self, **kwargs):<br/>    self.context_properties.append(self.create_context_property(**kwargs))<br/><br/>def add_cookie(self, key, value):<br/><br/>    if "cookies" in self is None:<br/>        self.cookies = {}<br/><br/>    self.cookies[key] = value<br/><br/>def add_payload_endpoint(self, **kwargs):<br/>    self.payload_endpoints.append(self.create_payload_endpoint(**kwargs))</pre>
<ol start="3">
<li>Now to define the three handler methods that we created in the previous step. The methods declared in the previous step depend upon inner methods of their own. These are mostly helper functions, which have little to do with the major focus of this chapter, and so we will leave these up to your implementation of the function, which you can create by studying the response body documentation of AWS Lambda functions and Alexa skills. A sample implementation can be found in our code repository for this chapter, between lines 65 and 102 of the <kbd>lambda_function.py</kbd> file at <a href="http://tiny.cc/HOPDLW_CH7_lfpy">http://tiny.cc/HOPDLW_CH7_lfpy</a>.</li>
<li class="mce-root">Next, we will set up <span>methods to generate the final response from the <kbd>AlexaResponse</kbd> class. Finally, we create methods that assimilate all the different parts—the context, event, payload, endpoints, and cookies—into a single object that is ready for interaction with the Alexa skill:</span></li>
</ol>
<pre style="color: black">    def get(self, remove_empty=True):<br/><br/>        response = {<br/>            'context': self.context,<br/>            'event': self.event<br/>        }<br/><br/>        if len(self.context_properties) &gt; 0:<br/>            response['context']['properties'] = self.context_properties<br/><br/>        if len(self.payload_endpoints) &gt; 0:<br/>            response['event']['payload']['endpoints'] = self.payload_endpoints<br/><br/>        if remove_empty:<br/>            if len(response['context']) &lt; 1:<br/>                response.pop('context')<br/><br/>        return response<br/><br/>    def set_payload(self, payload):<br/>        self.event['payload'] = payload<br/><br/>    def set_payload_endpoint(self, payload_endpoints):<br/>        self.payload_endpoints = payload_endpoints<br/><br/>    def set_payload_endpoints(self, payload_endpoints):<br/>        if 'endpoints' not in self.event['payload']:<br/>            self.event['payload']['endpoints'] = []<br/><br/>        self.event['payload']['endpoints'] = payload_endpoints</pre>
<ol start="5">
<li class="mce-root"><span>The <kbd>AlexaResponse</kbd> class</span> is now complete<span>. We will now move on to connect with the DynamoDB service using the following line:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">aws_dynamodb = boto3.client('dynamodb')</pre>
<ol start="6">
<li class="mce-root"><span>Next, we define the primary method and entry point for the file—the</span> <kbd>lambda_handler</kbd> <span>method:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">def lambda_handler(request, context):<br/><br/>    # JSON dump for the request<br/>    print('Request: ')<br/>    print(json.dumps(request))<br/><br/>    if context is not None:<br/>        print('Context: ')<br/>        print(context)</pre>
<p style="padding-left: 60px" class="mce-root"><span>We will continue adding to the preceding method for the rest of this step. In the preceding lines, we declare the</span> <kbd>lambda_handler</kbd> <span>method, which accepts the <kbd>request</kbd> and <kbd>context</kbd> objects from the Alexa skill. It then makes a JSON dump of the request so that we can later observe it from the Amazon CloudWatch dashboard. Next, it makes of a dump of the context if any was attached to the request:</span></p>
<pre style="color: black">    # Validate we have an Alexa directive<br/>    if 'directive' not in request:<br/>        aer = AlexaResponse(<br/>            name='ErrorResponse',<br/>            payload={'type': 'INVALID_DIRECTIVE',<br/>                     'message': 'Missing key: directive, Is the request a valid Alexa Directive?'})<br/>        return send_response(aer.get())</pre>
<p style="padding-left: 60px" class="mce-root"><span>We then validate whether we have a valid Alexa directive in the request, and if none is found, an error message is generated and sent back as the response. Note the usage of the</span> <kbd>AlexaResponse</kbd> <span>class object here. We will be using it in the future to generate responses from this script:</span></p>
<pre style="color: black">    # Check the payload version<br/>    payload_version = request['directive']['header']['payloadVersion']<br/>    if payload_version != '3':<br/>        aer = AlexaResponse(<br/>            name='ErrorResponse',<br/>            payload={'type': 'INTERNAL_ERROR',<br/>                     'message': 'This skill only supports Smart Home API version 3'})<br/>        return send_response(aer.get())</pre>
<p class="mce-root"><span>Similarly, another check is made to ensure that the payload version being requested is 3. This is because we have only developed it for the Smart Home API version 3 of Alexa:</span></p>
<ol>
<li class="mce-root"><span>First, we open the request and see what is being requested:</span></li>
</ol>
<pre style="color: black">    name = request['directive']['header']['name']<br/>    namespace = request['directive']['header']['namespace']</pre>
<ol start="2">
<li style="color: black">Then, we handle the incoming request from Alexa based on the <kbd>namespace</kbd>. Note that this sample accepts any <kbd>grant</kbd> request, but in your implementation, you will use the code and token to get and store access tokens:</li>
</ol>
<pre style="color: black">    if namespace == 'Alexa.Authorization':<br/>        if name == 'AcceptGrant':<br/>            grant_code = request['directive']['payload']['grant']['code']<br/>            grantee_token = request['directive']['payload']['grantee']['token']<br/>            aar = AlexaResponse(namespace='Alexa.Authorization', name='AcceptGrant.Response')<br/>            return send_response(aar.get())</pre>
<p style="color: black;padding-left: 60px">The preceding condition acts on the Alexa authorization request.</p>
<ol start="3">
<li style="color: black">For the discovery and the action to turn off the switch, we use the following code:</li>
</ol>
<pre style="color: black">    if namespace == 'Alexa.Discovery':<br/>        if name == 'Discover':<br/>            adr = AlexaResponse(namespace='Alexa.Discovery', name='Discover.Response')<br/>            capability_alexa = adr.create_payload_endpoint_capability()<br/>            capability_alexa_powercontroller = adr.create_payload_endpoint_capability(<br/>                interface='Alexa.PowerController',<br/>                supported=[{'name': 'powerState'}])<br/>            adr.add_payload_endpoint(<br/>                friendly_name='Sample Switch',<br/>                endpoint_id='sample-switch-01',<br/>                capabilities=[capability_alexa, capability_alexa_powercontroller])<br/>            return send_response(adr.get())<br/>       <br/>        if namespace == 'Alexa.PowerController':<br/>            endpoint_id = request['directive']['endpoint']['endpointId']<br/>            power_state_value = 'OFF' if name == 'TurnOff' else 'ON'<br/>            correlation_token = request['directive']['header']['correlationToken']</pre>
<p style="color: black;padding-left: 60px">This sample always returns a <kbd>success</kbd> response for either a request to <kbd>TurnOff</kbd> or <kbd>TurnOn.</kbd></p>
<ol start="4">
<li style="color: black">Now, we check for an error when setting the state:</li>
</ol>
<pre style="color: black;padding-left: 60px">        state_set = set_device_state(endpoint_id=endpoint_id, state='powerState', value=power_state_value)<br/>        if not state_set:<br/>            return AlexaResponse(<br/>                name='ErrorResponse',<br/>                payload={'type': 'ENDPOINT_UNREACHABLE', 'message': 'Unable to reach endpoint database.'}).get()<br/><br/>        apcr = AlexaResponse(correlation_token=correlation_token)<br/>        apcr.add_context_property(namespace='Alexa.PowerController', name='powerState', value=power_state_value)<br/>        return send_response(apcr.get())</pre>
<ol start="5">
<li style="color: black">Finally, we extract the directive name and the namespace of the directive to determine the type of response to be sent back. Depending upon the directives being sent, a different response is generated and finally sent using the <kbd>AlexaResponse</kbd> class object.</li>
<li class="mce-root"><span>Note the usage of the</span> <kbd>send_response</kbd> <span>method in the code in the previous step. We need to define that method. Its task is to send the</span> <kbd>AlexaResponse</kbd> <span>object in JSON format and to log it for observation in Amazon CloudWatch:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">def send_response(response):<br/>    print('Response: ')<br/>    print(json.dumps(response))<br/>    return response</pre>
<ol start="7">
<li class="mce-root">Update <span>the</span> <kbd>device state</kbd> <span>method. Since we're building automation for a simple switch device using Alexa, we'll need to maintain the state information of the switch. We do this by storing its state in DynamoDB. We will add an update method for this, as shown in the following code:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">def set_device_state(endpoint_id, state, value):<br/>    attribute_key = state + 'Value'<br/>    response = aws_dynamodb.update_item(<br/>        TableName='SmartHome',<br/>        Key={'ItemId': {'S': endpoint_id}},<br/>        AttributeUpdates={attribute_key: {'Action': 'PUT', 'Value': {'S': value}}})<br/>    print(response)<br/>    if response['ResponseMetadata']['HTTPStatusCode'] == 200:<br/>        return True<br/>    else:<br/>        return False</pre>
<p>Next, we will test the Lambda function.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing the Lambda function</h1>
                </header>
            
            <article>
                
<p>We can now check whether our function responds properly. To do this, we must create a test in the Lambda function's dashboard by going through these steps:</p>
<ol>
<li>On the Lambda function page for the function that we created in the previous sections, at the top right, click on <span class="packt_screen">Test</span>.</li>
<li>A dialog box will appear with the options to write a new test or use an existing one. Choose the option to <span class="packt_screen">Create new test event</span>.</li>
<li>In the <span class="packt_screen">Event</span> <span class="packt_screen">template</span>, make that sure <span class="packt_screen">Hello World</span> is selected.</li>
<li>Next, provide the <span class="packt_screen">Event</span> <span class="packt_screen">name</span> of <kbd>directiveDiscovery</kbd>.</li>
<li class="mce-root"><span>Enter the following JSON into the editor:</span></li>
</ol>
<pre style="color: black;padding-left: 60px">{<br/>  "directive": {<br/>    "header": {<br/>      "namespace": "Alexa.Discovery",<br/>      "name": "Discover",<br/>      "payloadVersion": "3",<br/>      "messageId": "1bd5d003-31b9-476f-ad03-71d471922820"<br/>    },<br/>    "payload": {<br/>      "scope": {<br/>        "type": "BearerToken",<br/>        "token": "access-token-from-skill"<br/>      }<br/>    }<br/>  }<br/>}</pre>
<p style="padding-left: 60px">At this point, your screen should resemble the following:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1378 image-border" src="assets/72352241-b56d-4536-b083-daebba4c21cf.png" style="width:45.92em;height:38.58em;"/></p>
<ol start="6">
<li>Scroll down and click on <span class="packt_screen">Create</span>.</li>
<li>Once you return to the Lambda function dashboard, at the top right, select the <kbd>directoryDiscover</kbd> test from the dropdown.</li>
<li>Click on <span class="packt_screen">Test</span>.</li>
</ol>
<p><span>On completion, t</span>he test will display the response status and the response of the Lambda function. You can see the results on the page at the top of the Lambda function dashboard, which will resemble the following screenshot:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1379 image-border" src="assets/ff23d8a3-8380-4e37-949f-efd3614544ca.png" style="width:55.00em;height:38.50em;"/></p>
<p>If the test fails, make sure you have followed the preceding steps carefully, making sure that the regions in which the different services exist are the same.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Testing the AWS Home Automation skill</h1>
                </header>
            
            <article>
                
<p>As the last phase of this project, we will be testing our skill in the Alexa Test simulator. To do this, go through the following steps:</p>
<ol>
<li>Go to <a href="https://alexa.amazon.com/">https://alexa.amazon.com</a> and log in.</li>
<li>Click on <span class="packt_screen">Skills</span> in the left-hand menu.</li>
<li>Click <span>on</span> <span class="packt_screen">Your Skills</span> <span>at the top right of the page.</span></li>
</ol>
<ol start="4">
<li>Select the <span class="packt_screen">DEV SKILL</span> tab.</li>
<li>Click on <span><span class="packt_screen">HomeAutomationSkill</span>. You should see the following screen:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1380 image-border" src="assets/246d6e58-cde0-45cd-9ad1-0f7dd1f02154.png" style="width:57.67em;height:24.58em;"/></p>
<ol start="6">
<li>Click on the <span class="packt_screen">Enable</span> button. You will be asked to allow access permissions to your Developer account.</li>
<li>Come back to the Alexa Developer console and click on <span class="packt_screen">Discover devices</span>. A new device called <span class="packt_screen">Sample Switch</span> <span>will be shown as available, as shown in the following screenshot:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1381 image-border" src="assets/77383ecb-ff77-43fa-99ae-c06f245dd01e.png" style="width:54.00em;height:20.25em;"/></p>
<ol start="8">
<li>Now, go to the <span class="packt_screen">Test</span> tab on the Alexa Skills Kit development page for the <span class="packt_screen">HomeAutomation</span> skill.</li>
</ol>
<ol start="9">
<li>In the simulator, type <kbd>alexa, turn on the sample switch</kbd>. If the request is accepted, then you will receive an <kbd>OK</kbd> from Alexa, as shown in the following screenshot:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1382 image-border" src="assets/40856d4c-4de8-458c-b4e7-83073a821f59.png" style="width:29.25em;height:21.67em;"/></p>
<p>To check whether the skill is actually working, you can go to your DynamoDB table <span class="packt_screen">SmartHome</span> and switch to the <span class="packt_screen">Items</span> tab of the table. You should be able to see the following record:</p>
<p class="CDPAlignCenter CDPAlign"><img class="alignnone size-full wp-image-1383 image-border" src="assets/f0949a1c-45e6-49d6-af20-309f9b4dd0a3.png" style="width:30.42em;height:22.17em;"/></p>
<p><span>Congratulations on successfully building a simple Home Automation skill in Alexa! You can play around with this skill and build your own home automation skills for Alexa. Once you are ready to publish them for a wider audience, you can follow the advice in the documentation available at <a href="https://developer.amazon.com/docs/alexa-for-business/create-and-publish-private-skills.html">https://developer.amazon.com/docs/alexa-for-business/create-and-publish-private-skills.html</a>.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Summary</h1>
                </header>
            
            <article>
                
<p>In this chapter, we covered how we can use AWS using its Python API—boto3. We explored the various options and configurational requirements for using the API and looked at an example of how to use it with the <span>Rekognition</span> API for recognizing celebrities. We then dove deep into how to create an Alexa skill for home automation, setting up the simple task of turning a switch on/off. This can be very easily extrapolated to other smart home devices. We looked at how Alexa skill logic can be hosted over AWS Lambda and observed from AWS CloudWatch. We also explored the storage of dynamic device data in Amazon DynamoDB.</p>
<p>In the upcoming chapter, we will see how we can use deep learning on Microsoft's Azure platform using Python.</p>


            </article>

            
        </section>
    </body></html>